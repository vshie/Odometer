<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odometer</title>
    <!-- Vuetify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.min.css" rel="stylesheet">
    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <!-- Custom styles -->
    <style>
        .stat-item {
            text-align: center;
            padding: 8px 4px;
        }
        .logo-wrapper {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        .app-logo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .stat-value {
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        .stat-icon {
            font-size: 1.2rem !important;
            margin-bottom: 4px;
        }
        .compact-card-title {
            padding: 8px 16px !important;
            min-height: unset !important;
        }
        .compact-card-title .v-icon {
            font-size: 20px !important;
        }
        .maintenance-table {
            border-radius: 8px;
            overflow: hidden;
        }
        .v-data-table td, .v-data-table th {
            padding: 0 8px !important;
        }
        /* Stacked bar chart styles */
        .usage-bar-container {
            width: 100%;
            height: 36px;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            background: #e0e0e0;
        }
        .usage-bar-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 8px;
            min-width: 0;
        }
        .usage-bar-armed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }
        .usage-bar-disarmed {
            background: linear-gradient(135deg, #FF9800 0%, #f57c00 100%);
        }
        .usage-bar-label {
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        /* Position grid for thrusters/motors */
        .position-grid {
            display: inline-block;
            border: 1px solid rgba(128,128,128,0.4);
            border-radius: 4px;
            padding: 8px;
            margin: 8px;
        }
        .position-grid-table {
            border-collapse: collapse;
        }
        .position-grid-table td {
            border: 1px solid rgba(128,128,128,0.4);
            padding: 12px 16px;
            text-align: center;
            min-width: 60px;
        }
        .position-cell {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .position-cell-sub {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 2px;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app :theme="isDarkMode ? 'dark' : 'light'">
            <v-main>
                <v-container fluid class="pa-3">
                    <!-- Vehicle name (editable) -->
                    <v-row dense>
                        <v-col cols="12" class="d-flex align-center">
                            <v-text-field
                                v-model="vehicleName"
                                label="Vehicle name"
                                dense
                                hide-details
                                outlined
                                class="vehicle-name-field"
                                style="max-width: 300px;"
                                @blur="saveVehicleName"
                            ></v-text-field>
                        </v-col>
                    </v-row>
                    <!-- Header: Logo + Stats + Pie Chart -->
                    <v-row dense>
                        <!-- Logo -->
                        <v-col cols="12" sm="3" class="d-flex align-stretch justify-center pa-2">
                            <div class="logo-wrapper">
                                <img src="/static/Odometer_logo.png" alt="Odometer Logo" class="app-logo">
                            </div>
                        </v-col>
                        <!-- Compact Stats Grid -->
                        <v-col cols="12" sm="5">
                            <v-card elevation="2" class="pa-2">
                                <v-row dense no-gutters>
                                    <v-col cols="4" class="stat-item">
                                        <v-icon class="stat-icon" color="primary">mdi-timer</v-icon>
                                        <div class="stat-value primary--text">{{ formatTime(stats.total_minutes) }}</div>
                                        <div class="stat-label">Total Uptime</div>
                                    </v-col>
                                    <v-col cols="4" class="stat-item">
                                        <v-icon class="stat-icon" color="success">mdi-shield-lock</v-icon>
                                        <div class="stat-value success--text">{{ formatTime(stats.armed_minutes) }}</div>
                                        <div class="stat-label">Armed</div>
                                    </v-col>
                                    <v-col cols="4" class="stat-item">
                                        <v-icon class="stat-icon" color="orange">mdi-shield-off</v-icon>
                                        <div class="stat-value orange--text">{{ formatTime(stats.disarmed_minutes) }}</div>
                                        <div class="stat-label">Disarmed</div>
                                    </v-col>
                                    <v-col cols="4" class="stat-item">
                                        <v-icon class="stat-icon" color="teal">mdi-battery</v-icon>
                                        <div class="stat-value teal--text">{{ stats.last_voltage.toFixed(1) }}V</div>
                                        <div class="stat-label">Voltage</div>
                                    </v-col>
                                    <v-col cols="4" class="stat-item">
                                        <v-icon class="stat-icon" color="deep-orange">mdi-thermometer</v-icon>
                                        <div class="stat-value deep-orange--text">{{ stats.cpu_temp.toFixed(0) }}°C</div>
                                        <div class="stat-label">CPU Temp</div>
                                    </v-col>
                                    <v-col cols="4" class="stat-item">
                                        <v-icon class="stat-icon" color="indigo">mdi-battery-sync</v-icon>
                                        <div class="stat-value indigo--text">{{ stats.battery_swaps }}</div>
                                        <div class="stat-label">Swaps</div>
                                    </v-col>
                                    <v-col cols="6" class="stat-item">
                                        <v-icon class="stat-icon" color="purple">mdi-flash</v-icon>
                                        <div class="stat-value purple--text">{{ stats.current_battery_wh.toFixed(1) }} Wh</div>
                                        <div class="stat-label">Current Battery</div>
                                    </v-col>
                                    <v-col cols="6" class="stat-item">
                                        <v-icon class="stat-icon" color="blue-grey">mdi-sigma</v-icon>
                                        <div class="stat-value blue-grey--text">{{ stats.total_wh_consumed.toFixed(1) }} Wh</div>
                                        <div class="stat-label">Lifetime Energy</div>
                                    </v-col>
                                </v-row>
                            </v-card>
                        </v-col>
                        <!-- Armed/Disarmed Bar -->
                        <v-col cols="12" sm="4">
                            <v-card elevation="2" class="pa-2 d-flex flex-column justify-center" style="height: 100%;">
                                <div class="caption text-center mb-1" style="opacity: 0.7;">Armed vs Disarmed Time</div>
                                <div class="usage-bar-container">
                                    <div 
                                        class="usage-bar-segment usage-bar-armed"
                                        :style="{ width: armedPercent + '%' }"
                                        v-if="stats.armed_minutes > 0"
                                    >
                                        <span class="usage-bar-label" v-if="armedPercent > 15">
                                            <v-icon x-small color="white">mdi-shield-lock</v-icon>
                                            {{ formatTimeCompact(stats.armed_minutes) }}
                                        </span>
                                    </div>
                                    <div 
                                        class="usage-bar-segment usage-bar-disarmed"
                                        :style="{ width: disarmedPercent + '%' }"
                                        v-if="stats.disarmed_minutes > 0"
                                    >
                                        <span class="usage-bar-label" v-if="disarmedPercent > 15">
                                            <v-icon x-small color="white">mdi-shield-off</v-icon>
                                            {{ formatTimeCompact(stats.disarmed_minutes) }}
                                        </span>
                                    </div>
                                </div>
                                <div class="d-flex justify-space-between mt-1">
                                    <div class="caption">
                                        <v-icon x-small color="success">mdi-square</v-icon>
                                        Armed: {{ formatTimeCompact(stats.armed_minutes) }} ({{ armedPercent.toFixed(1) }}%)
                                    </div>
                                    <div class="caption">
                                        <v-icon x-small color="orange">mdi-square</v-icon>
                                        Disarmed: {{ formatTimeCompact(stats.disarmed_minutes) }} ({{ disarmedPercent.toFixed(1) }}%)
                                    </div>
                                </div>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Historical Chart -->
                    <v-row dense class="mt-2">
                        <v-col cols="12">
                            <v-card elevation="2">
                                <v-card-title class="compact-card-title teal darken-1 white--text py-1">
                                    <v-icon color="white" class="mr-2">mdi-chart-line</v-icon>
                                    Last 15 Minutes
                                    <v-progress-circular
                                        v-if="loading"
                                        indeterminate
                                        color="white"
                                        size="16"
                                        width="2"
                                        class="ml-2"
                                    ></v-progress-circular>
                                </v-card-title>
                                <v-card-text class="pa-2">
                                    <div style="position: relative; height: 200px; width: 100%;">
                                        <canvas id="historyChart"></canvas>
                                    </div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Usage History & Export -->
                    <v-row dense class="mt-2">
                        <v-col cols="12">
                            <v-card elevation="2">
                                <v-card-title class="compact-card-title teal darken-1 white--text py-1">
                                    <v-icon color="white" class="mr-2">mdi-history</v-icon>
                                    Usage History
                                    <v-spacer></v-spacer>
                                    <v-btn x-small color="primary" class="mr-1" @click="downloadOdometerData">
                                        <v-icon x-small left>mdi-download</v-icon>CSV
                                    </v-btn>
                                    <v-btn x-small color="secondary" class="mr-1" @click="exportPdf">
                                        <v-icon x-small left>mdi-file-pdf-box</v-icon>PDF
                                    </v-btn>
                                    <v-btn x-small color="error" @click="showClearDialog">
                                        <v-icon x-small left>mdi-delete</v-icon>Clear
                                    </v-btn>
                                </v-card-title>
                                <v-card-text class="pa-0">
                                    <v-data-table
                                        :headers="usageHeaders"
                                        :items="allUsage"
                                        :items-per-page="3"
                                        dense
                                        class="elevation-0"
                                        :footer-props="{ 'items-per-page-options': [3, 5, 10] }"
                                    >
                                        <template v-slot:item.start_time="{ item }">
                                            {{ formatDateShort(item.start_time) }}
                                        </template>
                                        <template v-slot:item.end_time="{ item }">
                                            {{ item.isCurrent ? 'Now' : formatDateShort(item.end_time) }}
                                        </template>
                                        <template v-slot:item.duration="{ item }">
                                            {{ item.isCurrent ? '-' : calculateDuration(item.start_time, item.end_time) }}
                                        </template>
                                        <template v-slot:item.start_voltage="{ item }">
                                            {{ item.start_voltage.toFixed(1) }}V
                                        </template>
                                        <template v-slot:item.end_voltage="{ item }">
                                            {{ item.isCurrent ? stats.last_voltage.toFixed(1) : item.end_voltage.toFixed(1) }}V
                                        </template>
                                        <template v-slot:item.total_ah="{ item }">
                                            {{ item.isCurrent ? (stats.current_battery_wh / stats.last_voltage).toFixed(2) : item.total_ah.toFixed(2) }}Ah
                                        </template>
                                        <template v-slot:item.status="{ item }">
                                            <v-chip :color="item.isCurrent ? 'success' : 'grey'" dark x-small>
                                                {{ item.isCurrent ? 'Active' : 'Done' }}
                                            </v-chip>
                                            <v-chip v-if="item.hard_use && !item.isCurrent" color="orange" dark x-small class="ml-1">
                                                Hard use
                                            </v-chip>
                                        </template>
                                    </v-data-table>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Thruster/Motor Stats (when vehicle has thrusters or motors) -->
                    <v-row dense class="mt-2" v-if="thrusterData.thruster_count > 0">
                        <v-col cols="12">
                            <v-card elevation="2">
                                <v-card-title class="compact-card-title cyan darken-2 white--text py-1">
                                    <v-icon color="white" class="mr-2">mdi-ferry</v-icon>
                                    {{ unitLabel }} Run Hours
                                </v-card-title>
                                <v-card-text class="pa-2">
                                    <div v-for="(grid, gIdx) in layoutGrids" :key="gIdx" class="mb-3">
                                        <div class="caption mb-1" style="opacity: 0.8;">{{ grid.label }}</div>
                                        <div class="position-grid">
                                            <table class="position-grid-table">
                                                <tbody>
                                                    <tr v-for="(row, rIdx) in grid.rows" :key="rIdx">
                                                        <td v-for="(id, cIdx) in row" :key="cIdx">
                                                            <div class="position-cell">{{ unitLabel }} {{ id }}</div>
                                                            <div class="position-cell-sub">{{ getThrusterRunTime(id) }}</div>
                                                            <div class="position-cell-sub">{{ getThrusterPwm(id) }}</div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Accessories -->
                    <v-row dense class="mt-2" v-if="accessoriesData.length > 0">
                        <v-col cols="12">
                            <v-card elevation="2">
                                <v-card-title class="compact-card-title deep-purple white--text py-1">
                                    <v-icon color="white" class="mr-2">mdi-cog</v-icon>
                                    Accessories
                                </v-card-title>
                                <v-card-text class="pa-2">
                                    <v-simple-table dense>
                                        <template v-slot:default>
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Ch</th>
                                                    <th>Run Time</th>
                                                    <th>Avg PWM</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="a in accessoriesData" :key="a.id">
                                                    <td>{{ a.name }}</td>
                                                    <td>{{ a.channel }}</td>
                                                    <td>{{ formatTime(a.run_minutes) }}</td>
                                                    <td>{{ a.avg_pwm_armed ? a.avg_pwm_armed + ' us' : '-' }}</td>
                                                </tr>
                                            </tbody>
                                        </template>
                                    </v-simple-table>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Maintenance Section (Combined) -->
                    <v-row dense class="mt-2 mb-2">
                        <v-col cols="12">
                            <v-card elevation="2">
                                <v-card-title class="compact-card-title indigo white--text py-1">
                                    <v-icon color="white" class="mr-2">mdi-tools</v-icon>
                                    Maintenance Log
                                    <v-spacer></v-spacer>
                                    <v-btn x-small color="primary" @click="downloadMaintenanceData">
                                        <v-icon x-small left>mdi-download</v-icon>CSV
                                    </v-btn>
                                </v-card-title>
                                <v-card-text class="pa-2">
                                    <!-- Add Form (inline) -->
                                    <v-form ref="form" v-model="validForm" @submit.prevent="submitMaintenanceForm">
                                        <v-row dense align="center">
                                            <v-col cols="12" sm="3">
                                                <v-select
                                                    v-model="newRecord.event_type"
                                                    :items="eventTypes"
                                                    label="Type"
                                                    dense
                                                    hide-details
                                                    outlined
                                                ></v-select>
                                            </v-col>
                                            <v-col cols="12" sm="7" v-if="newRecord.event_type !== 'Add Device'">
                                                <v-text-field
                                                    v-model="newRecord.details"
                                                    label="Details"
                                                    dense
                                                    hide-details
                                                    outlined
                                                ></v-text-field>
                                            </v-col>
                                            <v-col cols="12" sm="7" v-if="newRecord.event_type === 'Add Device'" class="d-flex align-center">
                                                <span class="caption">Enter device name and channel below</span>
                                            </v-col>
                                            <v-col cols="12" sm="2">
                                                <v-btn 
                                                    block
                                                    small
                                                    color="success" 
                                                    :disabled="!canSubmitMaintenance"
                                                    @click="submitMaintenanceForm"
                                                >
                                                    <v-icon small left>mdi-plus</v-icon>Add
                                                </v-btn>
                                            </v-col>
                                        </v-row>
                                                        <!-- Add Device: name + channel -->
                                        <v-row dense v-if="newRecord.event_type === 'Add Device'">
                                            <v-col cols="12" sm="6">
                                                <v-text-field
                                                    v-model="newRecord.device_name"
                                                    label="Device name"
                                                    dense
                                                    hide-details
                                                    outlined
                                                ></v-text-field>
                                            </v-col>
                                            <v-col cols="12" sm="4">
                                                <v-select
                                                    v-model="newRecord.device_channel"
                                                    :items="channelOptions"
                                                    label="Channel"
                                                    dense
                                                    hide-details
                                                    outlined
                                                ></v-select>
                                            </v-col>
                                        </v-row>
                                        <!-- Thruster/Motor options for Replacement, Repair, Sticking -->
                                        <v-row dense v-if="showThrusterOptions">
                                            <v-col cols="12" sm="6">
                                                <v-select
                                                    v-model="newRecord.thruster_ids"
                                                    :items="thrusterOptions"
                                                    :label="unitLabel + '(s)'"
                                                    multiple
                                                    chips
                                                    small-chips
                                                    dense
                                                    hide-details
                                                    outlined
                                                    :rules="thrusterSelectRules"
                                                ></v-select>
                                            </v-col>
                                            <v-col cols="12" sm="6" v-if="showResetRunHoursOption">
                                                <v-checkbox
                                                    v-model="newRecord.reset_run_hours"
                                                    :label="'Reset run hours for selected ' + unitLabel.toLowerCase() + '(s)'"
                                                    dense
                                                    hide-details
                                                    class="mt-0"
                                                ></v-checkbox>
                                            </v-col>
                                        </v-row>
                                    </v-form>
                                    <v-divider class="my-2"></v-divider>
                                    <!-- Maintenance Table -->
                                    <v-data-table
                                        :headers="maintenanceHeaders"
                                        :items="maintenanceLog"
                                        :items-per-page="5"
                                        dense
                                        class="elevation-0"
                                        :footer-props="{ 'items-per-page-options': [5, 10, 15] }"
                                    >
                                        <template v-slot:item.timestamp="{ item }">
                                            {{ formatDateShort(item.timestamp) }}
                                        </template>
                                        <template v-slot:item.event_type="{ item }">
                                            <v-chip :color="getEventTypeColor(item.event_type)" dark x-small>
                                                {{ item.event_type }}
                                            </v-chip>
                                        </template>
                                        <template v-slot:item.thruster_ids="{ item }">
                                            <span v-if="item.thruster_ids && item.thruster_ids.length">
                                                {{ item.thruster_ids.map(i => (unitLabel === 'Motor' ? 'M' : 'T') + i).join(', ') }}
                                                <v-chip v-if="item.reset_run_hours" x-small color="success" dark class="ml-1">Reset</v-chip>
                                            </span>
                                            <span v-else class="grey--text">-</span>
                                        </template>
                                        <template v-slot:item.actions="{ item }">
                                            <v-icon x-small class="mr-1" @click="openEditDialog(item)">mdi-pencil</v-icon>
                                            <v-icon x-small color="error" @click="openDeleteDialog(item)">mdi-delete</v-icon>
                                        </template>
                                    </v-data-table>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Edit Maintenance Dialog -->
                    <v-dialog v-model="editDialog.show" max-width="500px">
                        <v-card>
                            <v-card-title class="blue darken-2 white--text">
                                <span>Edit Record Time</span>
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <v-form ref="editForm">
                                    <v-row>
                                        <v-col cols="12">
                                            <v-text-field
                                                v-model="editDialog.date"
                                                label="Date"
                                                type="date"
                                                required
                                            ></v-text-field>
                                        </v-col>
                                        <v-col cols="12">
                                            <v-text-field
                                                v-model="editDialog.time"
                                                label="Time"
                                                type="time"
                                                required
                                            ></v-text-field>
                                        </v-col>
                                    </v-row>
                                </v-form>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" text @click="editDialog.show = false">Cancel</v-btn>
                                <v-btn color="blue darken-1" text @click="saveEditedRecord">Save</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Delete Maintenance Dialog -->
                    <v-dialog v-model="deleteDialog.show" max-width="500px">
                        <v-card>
                            <v-card-title class="error white--text">
                                <span>Delete Maintenance Record</span>
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <p class="text-body-1">
                                    <v-icon color="warning" class="mr-2">mdi-alert</v-icon>
                                    Are you sure you want to delete this maintenance record?
                                </p>
                                <v-list-item v-if="deleteDialog.item" two-line class="my-2 pa-2" outlined>
                                    <v-list-item-content>
                                        <v-list-item-title>
                                            <v-chip :color="getEventTypeColor(deleteDialog.item.event_type)" dark>
                                                {{ deleteDialog.item.event_type }}
                                            </v-chip>
                                        </v-list-item-title>
                                        <v-list-item-subtitle class="mt-1">
                                            <strong>{{ formatDate(deleteDialog.item.timestamp) }}</strong>
                                        </v-list-item-subtitle>
                                        <v-list-item-subtitle class="mt-1 text-wrap">
                                            {{ deleteDialog.item.details }}
                                        </v-list-item-subtitle>
                                    </v-list-item-content>
                                </v-list-item>
                                <v-checkbox
                                    v-if="deleteDialog.step === 1"
                                    v-model="deleteDialog.confirmed"
                                    label="I understand this action cannot be undone"
                                    class="mt-4"
                                ></v-checkbox>
                                <v-alert
                                    v-if="deleteDialog.step === 2"
                                    type="warning"
                                    class="mt-4"
                                >
                                    This is your final confirmation. This record will be permanently deleted.
                                </v-alert>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue-grey darken-1" text @click="cancelDeleteDialog">Cancel</v-btn>
                                <v-btn 
                                    v-if="deleteDialog.step === 1"
                                    color="error" 
                                    text 
                                    :disabled="!deleteDialog.confirmed" 
                                    @click="deleteDialog.step = 2"
                                >Continue</v-btn>
                                <v-btn 
                                    v-if="deleteDialog.step === 2"
                                    color="error" 
                                    text 
                                    @click="deleteMaintenanceRecord"
                                >Confirm Delete</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Clear Data Confirmation Dialog -->
                    <v-dialog v-model="clearDialog.show" max-width="500px">
                        <v-card>
                            <v-card-title class="error white--text">
                                <span>Clear Temperature & Voltage History</span>
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <p class="text-body-1">
                                    <v-icon color="warning" class="mr-2">mdi-alert</v-icon>
                                    This will remove all historical temperature and voltage data, but will preserve uptime statistics.
                                </p>
                                <p class="text-body-1 mt-2">
                                    Are you sure you want to continue?
                                </p>
                                <v-checkbox
                                    v-if="clearDialog.step === 1"
                                    v-model="clearDialog.confirmed"
                                    label="I understand this action cannot be undone"
                                    class="mt-4"
                                ></v-checkbox>
                                <v-alert
                                    v-if="clearDialog.step === 2"
                                    type="warning"
                                    class="mt-4"
                                >
                                    This is your final confirmation. All temperature and voltage history will be permanently deleted.
                                </v-alert>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue-grey darken-1" text @click="cancelClearDialog">Cancel</v-btn>
                                <v-btn 
                                    v-if="clearDialog.step === 1"
                                    color="error" 
                                    text 
                                    :disabled="!clearDialog.confirmed" 
                                    @click="clearDialog.step = 2"
                                >Continue</v-btn>
                                <v-btn 
                                    v-if="clearDialog.step === 2"
                                    color="error" 
                                    text 
                                    @click="clearTempVoltageHistory"
                                >Confirm Delete</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Snackbar for notifications -->
                    <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="3000">
                        {{ snackbar.text }}
                        <template v-slot:action="{ attrs }">
                            <v-btn icon v-bind="attrs" @click="snackbar.show = false">
                                <v-icon>mdi-close</v-icon>
                            </v-btn>
                        </template>
                    </v-snackbar>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify({
                theme: {
                    dark: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
                }
            }),
            data() {
                return {
                    isDarkMode: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches,
                    stats: {
                        total_minutes: 0,
                        armed_minutes: 0,
                        disarmed_minutes: 0,
                        battery_swaps: 0,
                        last_voltage: 0.0,
                        cpu_temp: 0.0,
                        total_wh_consumed: 0.0,
                        current_battery_wh: 0.0,
                    },
                    maintenanceLog: [],
                    maintenanceHeaders: [
                        { text: 'Date/Time', value: 'timestamp' },
                        { text: 'Event Type', value: 'event_type' },
                        { text: 'Details', value: 'details' },
                        { text: 'Thrusters/Motors', value: 'thruster_ids' },
                        { text: 'Actions', value: 'actions', sortable: false, align: 'end' }
                    ],
                    newRecord: {
                        event_type: '',
                        details: '',
                        thruster_ids: [],
                        reset_run_hours: false,
                        device_name: '',
                        device_channel: 1
                    },
                    eventTypesBase: ['Add Device', 'Repair', 'Replacement', 'Maintenance', 'Inspection', 'Note'],
                    validForm: false,
                    snackbar: {
                        show: false,
                        text: '',
                        color: 'success'
                    },
                    updateInterval: null,
                    themeCheckInterval: null,
                    themeObserver: null,
                    usageChart: null,
                    historyChart: null,
                    historicalData: [],
                    loading: false,
                    editDialog: {
                        show: false,
                        item: null,
                        date: '',
                        time: ''
                    },
                    updateCount: 0,
                    themeMediaQuery: null,
                    clearDialog: {
                        show: false,
                        step: 1,
                        confirmed: false
                    },
                    deleteDialog: {
                        show: false,
                        step: 1,
                        confirmed: false,
                        item: null
                    },
                    chartOptions: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: {
                                        minute: 'MMM d HH:mm',
                                        hour: 'MMM d HH:mm',
                                        day: 'MMM d',
                                        week: 'MMM d',
                                        month: 'MMM yyyy'
                                    }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                grid: {
                                    color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            'y-voltage': {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Voltage (V)',
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                ticks: {
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                grid: {
                                    color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            'y-temp': {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)',
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                ticks: {
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                grid: {
                                    color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return format(new Date(tooltipItems[0].parsed.x), 'MMM d, yyyy HH:mm:ss');
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2);
                                            if (context.dataset.yAxisID === 'y-voltage') {
                                                label += ' V';
                                            } else if (context.dataset.yAxisID === 'y-temp') {
                                                label += ' °C';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    },
                    usageHeaders: [
                        { text: 'Start', value: 'start_time' },
                        { text: 'End', value: 'end_time' },
                        { text: 'Duration', value: 'duration' },
                        { text: 'Start V', value: 'start_voltage' },
                        { text: 'End V', value: 'end_voltage' },
                        { text: 'Ah', value: 'total_ah' },
                        { text: 'Status', value: 'status' }
                    ],
                    usage: [],
                    currentUsage: null,
                    allUsage: [],
                    thrusterData: {
                        thruster_count: 0,
                        mav_type: -1,
                        layout: { unit: 'thruster', unit_plural: 'thrusters', grids: [] },
                        thrusters: []
                    },
                    vehicleName: '',
                    accessoriesData: []
                }
            },
                mounted() {
                this.fetchStats();
                this.fetchVehicle();
                this.fetchMaintenanceLog();
                this.fetchHistoricalData();
                this.fetchUsage();
                this.fetchThrusters();
                this.fetchAccessories();
                
                // Set up initial theme detection
                this.setupThemeDetection();
                
                // Update stats every 30 seconds, but only if tab is visible
                this.updateInterval = setInterval(() => {
                    if (!document.hidden) {
                        this.fetchStats();
                        this.fetchUsage();
                        this.fetchThrusters();
                        this.fetchAccessories();
                        // Fetch historical data every 2 cycles (1 minute) instead of every 4 cycles (2 minutes)
                        if (this.updateCount % 2 === 0) {
                            this.fetchHistoricalData();
                        }
                        // Check for theme changes in BlueOS every cycle
                        this.checkBlueOSTheme();
                        this.updateCount++;
                    }
                }, 30000);
                
                // Set a shorter interval just for theme checking (every 2 seconds)
                this.themeCheckInterval = setInterval(() => {
                    if (!document.hidden) {
                        this.checkBlueOSTheme();
                    }
                }, 2000);
            },
            beforeDestroy() {
                clearInterval(this.updateInterval);
                clearInterval(this.themeCheckInterval);
                
                // Remove mutation observer if it exists
                if (this.themeObserver) {
                    this.themeObserver.disconnect();
                }
                
                // Remove theme change listeners
                if (this.themeMediaQuery) {
                    this.themeMediaQuery.removeEventListener('change', this.handleThemeChange);
                }
                // Cleanup charts
                if (this.usageChart) {
                    this.usageChart.destroy();
                }
                if (this.historyChart) {
                    this.historyChart.destroy();
                }
            },
            watch: {
                isDarkMode() {
                    // Update Vuetify theme when dark mode changes
                    this.$vuetify.theme.dark = this.isDarkMode;
                    // Update chart themes
                    this.updateChartsTheme();
                }
            },
            computed: {
                armedPercent() {
                    const armed = Number(this.stats.armed_minutes || 0);
                    const disarmed = Number(this.stats.disarmed_minutes || 0);
                    const total = armed + disarmed;
                    if (total <= 0) return 0;
                    return (armed / total) * 100;
                },
                disarmedPercent() {
                    const armed = Number(this.stats.armed_minutes || 0);
                    const disarmed = Number(this.stats.disarmed_minutes || 0);
                    const total = armed + disarmed;
                    if (total <= 0) return 0;
                    return (disarmed / total) * 100;
                },
                thrusterOptions() {
                    const unit = (this.thrusterData.layout && this.thrusterData.layout.unit) || 'thruster';
                    const cap = unit.charAt(0).toUpperCase() + unit.slice(1);
                    return this.thrusterData.thrusters.map(t => ({
                        text: cap + ' ' + t.id,
                        value: t.id
                    }));
                },
                layoutGrids() {
                    return (this.thrusterData.layout && this.thrusterData.layout.grids) || [];
                },
                unitLabel() {
                    return (this.thrusterData.layout && this.thrusterData.layout.unit) === 'motor' ? 'Motor' : 'Thruster';
                },
                eventTypes() {
                    const sticking = this.unitLabel === 'Motor' ? 'Motor Sticking' : 'Thruster Sticking';
                    const base = this.eventTypesBase;
                    const idx = base.indexOf('Note');
                    return idx >= 0 ? [...base.slice(0, idx), sticking, ...base.slice(idx)] : [...base, sticking];
                },
                showThrusterOptions() {
                    const sticking = this.unitLabel === 'Motor' ? 'Motor Sticking' : 'Thruster Sticking';
                    return (this.newRecord.event_type === 'Replacement' || 
                            this.newRecord.event_type === 'Repair' || 
                            this.newRecord.event_type === sticking) && 
                           this.thrusterData.thruster_count > 0;
                },
                showResetRunHoursOption() {
                    return (this.newRecord.event_type === 'Replacement' || 
                            this.newRecord.event_type === 'Repair') && 
                           this.thrusterData.thruster_count > 0;
                },
                thrusterSelectRules() {
                    const sticking = this.unitLabel === 'Motor' ? 'Motor Sticking' : 'Thruster Sticking';
                    if (this.newRecord.event_type === sticking) {
                        return [v => (v && v.length > 0) || 'Select at least one ' + this.unitLabel.toLowerCase()];
                    }
                    return [];
                },
                canSubmitMaintenance() {
                    if (!this.newRecord.event_type) return false;
                    if (this.newRecord.event_type === 'Add Device') {
                        return !!this.newRecord.device_name && !!this.newRecord.device_channel;
                    }
                    if (!this.newRecord.details) return false;
                    const sticking = this.unitLabel === 'Motor' ? 'Motor Sticking' : 'Thruster Sticking';
                    if (this.newRecord.event_type === sticking) {
                        return this.newRecord.thruster_ids && this.newRecord.thruster_ids.length > 0;
                    }
                    return true;
                },
                channelOptions() {
                    return [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16].map(n => ({ text: 'Ch ' + n, value: n }));
                }
            },
            methods: {
                setupThemeDetection() {
                    // First try to detect BlueOS theme through parent window
                    const detected = this.checkBlueOSTheme();
                    
                    // Try to set up a mutation observer for the parent document
                    try {
                        if (window.parent && window.parent.document && window.parent.document.body) {
                            // Create a mutation observer to watch for class changes on the parent body
                            this.themeObserver = new MutationObserver((mutations) => {
                                for (const mutation of mutations) {
                                    if (mutation.type === 'attributes' && 
                                        (mutation.attributeName === 'class' || 
                                         mutation.attributeName === 'data-theme')) {
                                        this.checkBlueOSTheme();
                                        break;
                                    }
                                }
                            });
                            
                            // Start observing the parent body for class and attribute changes
                            this.themeObserver.observe(window.parent.document.body, {
                                attributes: true,
                                attributeFilter: ['class', 'data-theme']
                            });
                            
                            console.log('Set up BlueOS theme mutation observer');
                        }
                    } catch (e) {
                        console.log('Unable to set up mutation observer for parent frame:', e);
                    }
                    
                    // As fallback, setup media query listener for system theme changes
                    this.themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    this.themeMediaQuery.addEventListener('change', this.handleThemeChange);
                },
                checkBlueOSTheme() {
                    try {
                        if (window.parent && window.parent.document) {
                            // Get BlueOS theme state - could be in different elements depending on version
                            const parentBody = window.parent.document.body;
                            const isDarkTheme = 
                                parentBody.classList.contains('theme--dark') || 
                                parentBody.getAttribute('data-theme') === 'dark' ||
                                parentBody.querySelector('.theme--dark') !== null;
                            
                            // Also check for specific CSS variables that might indicate theme
                            const computedStyle = window.getComputedStyle(parentBody);
                            const bgColor = computedStyle.getPropertyValue('--v-background-base') || 
                                           computedStyle.backgroundColor;
                            
                            // If we have a background color, check if it's dark
                            if (bgColor && bgColor !== '') {
                                // If it's a dark background and we're not in dark mode, or vice versa
                                const isDarkBg = this.isColorDark(bgColor);
                                if (isDarkBg !== null && isDarkBg !== this.isDarkMode) {
                                    console.log(`BlueOS theme detected as ${isDarkBg ? 'dark' : 'light'} based on background color`);
                                    this.isDarkMode = isDarkBg;
                                    return true;
                                }
                            }
                            
                            // Only update if different from current state
                            if (this.isDarkMode !== isDarkTheme) {
                                console.log(`BlueOS theme changed to ${isDarkTheme ? 'dark' : 'light'}`);
                                this.isDarkMode = isDarkTheme;
                            }
                            
                            // Successful BlueOS theme detection
                            return true;
                        }
                    } catch (e) {
                        console.log('Unable to access parent frame for theme detection');
                    }
                    return false;
                },
                isColorDark(color) {
                    try {
                        // Parse the color to get RGB values
                        let r, g, b;
                        
                        // Handle hex color
                        if (color.startsWith('#')) {
                            if (color.length === 4) { // #RGB format
                                r = parseInt(color[1] + color[1], 16);
                                g = parseInt(color[2] + color[2], 16);
                                b = parseInt(color[3] + color[3], 16);
                            } else { // #RRGGBB format
                                r = parseInt(color.slice(1, 3), 16);
                                g = parseInt(color.slice(3, 5), 16);
                                b = parseInt(color.slice(5, 7), 16);
                            }
                        } 
                        // Handle rgb/rgba color
                        else if (color.startsWith('rgb')) {
                            const parts = color.match(/(\d+)/g);
                            if (parts && parts.length >= 3) {
                                r = parseInt(parts[0]);
                                g = parseInt(parts[1]);
                                b = parseInt(parts[2]);
                            }
                        }
                        else {
                            return null; // Unsupported color format
                        }
                        
                        // Calculate relative luminance using sRGB
                        // Formula: 0.2126*R + 0.7152*G + 0.0722*B
                        const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
                        
                        // If luminance is less than 0.5, it's considered dark
                        return luminance < 0.5;
                    } catch (e) {
                        console.log('Error parsing color:', e);
                        return null;
                    }
                },
                handleThemeChange(e) {
                    // Only apply system preference if we couldn't detect BlueOS theme
                    if (!this.checkBlueOSTheme()) {
                        this.isDarkMode = e.matches;
                    }
                },
                updateChartsTheme() {
                    // Update chart colors based on theme
                    if (this.historyChart) {
                        // Update grid and text colors
                        const textColor = this.isDarkMode ? '#ffffff' : '#666666';
                        const gridColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                        
                        this.historyChart.options.scales.x.grid.color = gridColor;
                        this.historyChart.options.scales.x.ticks.color = textColor;
                        this.historyChart.options.scales['y-voltage'].grid.color = gridColor;
                        this.historyChart.options.scales['y-voltage'].ticks.color = textColor;
                        this.historyChart.options.scales['y-temp'].grid.color = gridColor;
                        this.historyChart.options.scales['y-temp'].ticks.color = textColor;
                        
                        this.historyChart.update();
                    }
                    
                    if (this.usageChart) {
                        // Update legend colors
                        this.usageChart.options.plugins.legend.labels.color = this.isDarkMode ? '#ffffff' : '#666666';
                        this.usageChart.update();
                    }
                },
                fetchVehicle() {
                    axios.get('/vehicle')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.vehicleName = response.data.data.name || '';
                            }
                        })
                        .catch(() => {});
                },
                saveVehicleName() {
                    axios.post('/vehicle', { name: this.vehicleName })
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.showSnackbar('Vehicle name saved');
                            }
                        })
                        .catch(() => {});
                },
                fetchAccessories() {
                    axios.get('/accessories')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.accessoriesData = response.data.data;
                            }
                        })
                        .catch(() => {});
                },
                exportPdf() {
                    window.location.href = '/export/pdf';
                },
                fetchStats() {
                    axios.get('/stats')
                        .then(response => {
                            if (response.data.status === 'success') {
                                // Save old values to check for changes
                                const oldTemp = this.stats.cpu_temp;
                                const oldVoltage = this.stats.last_voltage;
                                
                                // Update stats
                                this.stats = response.data.data;
                                this.updateUsageChart();
                                
                                // If values changed, immediately add the new point to the chart for real-time updates
                                if (this.historyChart && 
                                    (oldTemp !== this.stats.cpu_temp || oldVoltage !== this.stats.last_voltage)) {
                                    
                                    const now = new Date();
                                    
                                    // Add new voltage point
                                    if (this.historyChart.data.datasets[0].data) {
                                        this.historyChart.data.labels.push(now);
                                        this.historyChart.data.datasets[0].data.push(this.stats.last_voltage);
                                    }
                                    
                                    // Add new temperature point if it's valid (greater than 0)
                                    if (this.historyChart.data.datasets[1].data && this.stats.cpu_temp > 0) {
                                        this.historyChart.data.datasets[1].data.push({
                                            x: now,
                                            y: this.stats.cpu_temp
                                        });
                                    }
                                    
                                    // Update the chart
                                    this.historyChart.update();
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching stats:', error);
                            this.showSnackbar('Failed to fetch vehicle stats', 'error');
                        });
                },
                fetchMaintenanceLog() {
                    axios.get('/maintenance')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.maintenanceLog = response.data.data;
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching maintenance log:', error);
                            this.showSnackbar('Failed to fetch maintenance log', 'error');
                        });
                },
                fetchThrusters() {
                    axios.get('/thrusters')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.thrusterData = response.data.data;
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching thruster stats:', error);
                        });
                },
                submitMaintenanceForm() {
                    if (!this.canSubmitMaintenance) return;
                    if (this.$refs.form && !this.$refs.form.validate()) return;

                    const payload = {
                        event_type: this.newRecord.event_type,
                        details: this.newRecord.event_type === 'Add Device' ? '' : this.newRecord.details,
                        thruster_ids: this.newRecord.thruster_ids || [],
                        reset_run_hours: this.newRecord.reset_run_hours || false
                    };
                    if (this.newRecord.event_type === 'Add Device') {
                        payload.device_name = this.newRecord.device_name;
                        payload.device_channel = this.newRecord.device_channel;
                    }

                    axios.post('/maintenance', payload)
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.showSnackbar('Maintenance record added successfully');
                                this.newRecord.event_type = '';
                                this.newRecord.details = '';
                                this.newRecord.thruster_ids = [];
                                this.newRecord.reset_run_hours = false;
                                this.newRecord.device_name = '';
                                this.newRecord.device_channel = 1;
                                if (this.$refs.form) this.$refs.form.reset();
                                this.fetchMaintenanceLog();
                                this.fetchThrusters();
                                this.fetchAccessories();
                            } else {
                                this.showSnackbar(response.data.message || 'Failed to add record', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error adding maintenance record:', error);
                            this.showSnackbar('Failed to add maintenance record', 'error');
                        });
                },
                downloadOdometerData() {
                    window.location.href = '/download/odometer';
                },
                downloadMaintenanceData() {
                    window.location.href = '/download/maintenance';
                },
                downloadCSV(csvData, filename) {
                    const blob = new Blob([csvData], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', filename);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },
                formatTime(minutes) {
                    const days = Math.floor(minutes / (60 * 24));
                    const hours = Math.floor((minutes % (60 * 24)) / 60);
                    const mins = minutes % 60;
                    
                    let result = '';
                    if (days > 0) result += `${days}d `;
                    if (hours > 0 || days > 0) result += `${hours}h `;
                    result += `${mins}m`;
                    
                    return result;
                },
                formatTimeCompact(minutes) {
                    const total = Math.max(0, Math.floor(Number(minutes || 0)));
                    const days = Math.floor(total / (60 * 24));
                    const hours = Math.floor((total % (60 * 24)) / 60);
                    const mins = total % 60;

                    if (days > 0) return `${days}d ${hours}h`;
                    if (hours > 0) return `${hours}h ${mins}m`;
                    return `${mins}m`;
                },
                formatDate(isoString) {
                    try {
                        const date = new Date(isoString);
                        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        return new Intl.DateTimeFormat(undefined, {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            timeZoneName: 'short',
                            timeZone: tz
                        }).format(date);
                    } catch (e) {
                        console.error('Error formatting date:', e);
                        return isoString;
                    }
                },
                formatDateShort(isoString) {
                    try {
                        const date = new Date(isoString);
                        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                        return new Intl.DateTimeFormat(undefined, {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZone: tz
                        }).format(date);
                    } catch (e) {
                        return isoString;
                    }
                },
                getEventTypeColor(type) {
                    const colors = {
                        'Add Device': 'deep-purple',
                        'Repair': 'red',
                        'Replacement': 'blue',
                        'Maintenance': 'green',
                        'Inspection': 'amber',
                        'Thruster Sticking': 'orange',
                        'Motor Sticking': 'orange',
                        'Note': 'grey'
                    };
                    return colors[type] || 'primary';
                },
                getThrusterRunTime(id) {
                    const t = this.thrusterData.thrusters.find(x => x.id === id);
                    return t ? this.formatTime(t.run_minutes) : '-';
                },
                getThrusterPwm(id) {
                    const t = this.thrusterData.thrusters.find(x => x.id === id);
                    return t && t.avg_pwm_armed ? t.avg_pwm_armed + ' us' : '-';
                },
                showSnackbar(text, color = 'success') {
                    this.snackbar.text = text;
                    this.snackbar.color = color;
                    this.snackbar.show = true;
                },
                updateUsageChart() {
                    const ctx = document.getElementById('usageChart');
                    // The UI no longer includes this canvas (we use the stacked bar instead).
                    // Guard to avoid runtime errors if the element isn't present.
                    if (!ctx) return;
                    const armedMinutes = this.stats.armed_minutes || 0;
                    const disarmedMinutes = this.stats.disarmed_minutes || 0;
                    
                    // Destroy previous chart if it exists
                    if (this.usageChart) {
                        this.usageChart.destroy();
                        this.usageChart = null;
                    }
                    
                    // If no data or zero total, show placeholder
                    if (armedMinutes === 0 && disarmedMinutes === 0) {
                        const placeholderData = {
                            labels: ['No Data Available'],
                            datasets: [{
                                data: [1],
                                backgroundColor: [this.isDarkMode ? '#424242' : '#e0e0e0'],
                                borderWidth: 0
                            }]
                        };
                        
                        this.usageChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: placeholderData,
                            options: this.getChartOptions(true)
                        });
                        return;
                    }
                    
                    // Prepare real data
                    const data = {
                        labels: ['Armed Time', 'Disarmed Time'],
                        datasets: [{
                            data: [armedMinutes, disarmedMinutes],
                            backgroundColor: ['#4CAF50', '#FFC107'],
                            borderWidth: 2,
                            borderColor: this.isDarkMode ? '#424242' : '#fff'
                        }]
                    };
                    
                    this.usageChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: data,
                        options: this.getChartOptions()
                    });
                },
                getChartOptions(isPlaceholder = false) {
                    return {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 500 },
                        cutout: '50%',
                        layout: {
                            padding: 0
                        },
                        plugins: {
                            legend: {
                                display: !isPlaceholder,
                                position: 'right',
                                labels: {
                                    padding: 4,
                                    color: this.isDarkMode ? '#ffffff' : '#666666',
                                    font: { size: 10 },
                                    boxWidth: 8
                                }
                            },
                            tooltip: {
                                enabled: !isPlaceholder,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        const formattedTime = this.formatTime(value);
                                        return `${label}: ${formattedTime} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    };
                },
                fetchHistoricalData() {
                    // If already loading, don't start another request
                    if (this.loading) return;
                    
                    this.loading = true;
                    
                    // Add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', `/download/odometer?t=${timestamp}`, true);
                    xhr.responseType = 'text';
                    
                    // Keep track of when this request started to avoid race conditions
                    const requestTimestamp = Date.now();
                    
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            try {
                                const csvData = xhr.responseText;
                                const lines = csvData.split('\n');
                                const headers = lines[0].split(',');
                                
                                // Find indices for timestamp, voltage and cpu_temp
                                const timestampIndex = headers.indexOf('timestamp');
                                const voltageIndex = headers.indexOf('voltage');
                                const cpuTempIndex = headers.indexOf('cpu_temp');
                                
                                if (timestampIndex === -1 || voltageIndex === -1) {
                                    throw new Error('Required columns not found in CSV data');
                                }
                                
                                // Parse data rows
                                const data = [];
                                for (let i = 1; i < lines.length; i++) {
                                    if (!lines[i].trim()) continue;
                                    
                                    const values = lines[i].split(',');
                                    if (values.length > Math.max(timestampIndex, voltageIndex, cpuTempIndex)) {
                                        const timestamp = new Date(values[timestampIndex]);
                                        let voltage = parseFloat(values[voltageIndex]);
                                        
                                        // Completely skip temperature readings that are missing, zero, or invalid
                                        let cpuTemp = null;
                                        if (cpuTempIndex !== -1 && values[cpuTempIndex] && values[cpuTempIndex].trim() !== '') {
                                            const tempValue = parseFloat(values[cpuTempIndex]);
                                            if (!isNaN(tempValue) && tempValue > 0) {
                                                cpuTemp = tempValue;
                                            }
                                        }
                                        
                                        if (!isNaN(voltage) && !isNaN(timestamp.getTime())) {
                                            data.push({
                                                timestamp,
                                                voltage,
                                                cpuTemp
                                            });
                                        }
                                    }
                                }
                                
                                console.log('Total data points loaded:', data.length);
                                this.historicalData = data;
                                this.updateHistoryChart();
                            } catch (e) {
                                console.error('Error parsing CSV data:', e);
                                this.showSnackbar('Error parsing CSV data: ' + e.message, 'error');
                            }
                        } else {
                            console.error('Failed to load CSV data:', xhr.status, xhr.statusText);
                            this.showSnackbar('Failed to load historical data', 'error');
                        }
                        // Clear loading after a slight delay to prevent flicker
                        setTimeout(() => {
                            this.loading = false;
                        }, 300);
                    };
                    
                    xhr.onerror = () => {
                        console.error('Network error while fetching CSV data');
                        this.showSnackbar('Network error while fetching data', 'error');
                        this.loading = false;
                    };
                    
                    xhr.send();
                },
                
                updateHistoryChart() {
                    if (!this.historyChart) {
                        const ctx = document.getElementById('historyChart');
                        this.historyChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [
                                    {
                                        label: 'Battery Voltage',
                                        yAxisID: 'y-voltage',
                                        data: [],
                                        borderColor: '#2196F3',
                                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'CPU Temperature',
                                        yAxisID: 'y-temp',
                                        data: [],
                                        borderColor: '#F44336',
                                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: this.chartOptions
                        });
                    }

                    try {
                        // Filter data to show the last 15 minutes, regardless of session
                        const fifteenMinutesAgo = new Date(Date.now() - 15 * 60 * 1000);
                        
                        const filteredData = this.historicalData
                            .filter(d => {
                                const timestamp = new Date(d.timestamp);
                                return timestamp >= fifteenMinutesAgo;
                            })
                            .sort((a, b) => a.timestamp - b.timestamp);

                        // Update voltage data
                        this.historyChart.data.datasets[0].data = filteredData.map(d => ({
                            x: d.timestamp,
                            y: d.voltage
                        }));

                        // Update temperature data (filter out invalid values)
                        this.historyChart.data.datasets[1].data = filteredData
                            .filter(d => d.cpuTemp !== null && d.cpuTemp > 0)
                            .map(d => ({
                                x: d.timestamp,
                                y: d.cpuTemp
                            }));

                        // Update the chart
                        this.historyChart.update();

                    } catch (e) {
                        console.error("Error updating chart:", e);
                    }
                },
                
                calculateDuration(startTime, endTime) {
                    const start = new Date(startTime);
                    const end = new Date(endTime);
                    const diff = end - start;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    return `${hours}h ${minutes}m`;
                },
                fetchUsage() {
                    axios.get('/missions')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.currentUsage = response.data.data.current_mission;
                                this.usage = response.data.data.completed_missions;
                                
                                // Combine current and completed usage sessions
                                const combinedUsage = [
                                    ...(this.currentUsage ? [{
                                        ...this.currentUsage,
                                        isCurrent: true,
                                        end_time: new Date().toISOString() // Current time for ongoing session
                                    }] : []),
                                    ...this.usage.map(m => ({
                                        ...m,
                                        isCurrent: false
                                    }))
                                ];

                                // Sort: current session always first, then completed by end_time descending
                                this.allUsage = combinedUsage.sort((a, b) => {
                                    if (a.isCurrent && !b.isCurrent) return -1;
                                    if (!a.isCurrent && b.isCurrent) return 1;
                                    const aEnd = a.end_time ? new Date(a.end_time).getTime() : 0;
                                    const bEnd = b.end_time ? new Date(b.end_time).getTime() : 0;
                                    if (aEnd !== bEnd) return bEnd - aEnd;
                                    const aStart = a.start_time ? new Date(a.start_time).getTime() : 0;
                                    const bStart = b.start_time ? new Date(b.start_time).getTime() : 0;
                                    return bStart - aStart;
                                });
                                
                                // Update chart with current usage data
                                this.updateHistoryChart();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching usage history:', error);
                            this.showSnackbar('Failed to fetch usage history', 'error');
                        });
                },
                showClearDialog() {
                    this.clearDialog.show = true;
                },
                cancelClearDialog() {
                    this.clearDialog.show = false;
                    this.resetClearDialog();
                },
                clearTempVoltageHistory() {
                    axios.post('/clear_history')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.showSnackbar('Temperature and voltage history cleared successfully');
                                this.fetchHistoricalData();
                            } else {
                                this.showSnackbar(response.data.message || 'Failed to clear temperature and voltage history', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error clearing temperature and voltage history:', error);
                            this.showSnackbar('Failed to clear temperature and voltage history', 'error');
                        })
                        .finally(() => {
                            this.clearDialog.show = false;
                            this.resetClearDialog();
                        });
                },
                resetClearDialog() {
                    // Reset dialog state after closing
                    setTimeout(() => {
                        this.clearDialog.step = 1;
                        this.clearDialog.confirmed = false;
                    }, 300);
                },
                openDeleteDialog(item) {
                    this.deleteDialog.item = item;
                    this.deleteDialog.show = true;
                },
                cancelDeleteDialog() {
                    this.deleteDialog.show = false;
                    this.resetDeleteDialog();
                },
                resetDeleteDialog() {
                    // Reset dialog state after closing
                    setTimeout(() => {
                        this.deleteDialog.step = 1;
                        this.deleteDialog.confirmed = false;
                        this.deleteDialog.item = null;
                    }, 300);
                },
                deleteMaintenanceRecord() {
                    if (!this.deleteDialog.item) return;
                    
                    axios.post('/maintenance/delete', {
                        timestamp: this.deleteDialog.item.timestamp
                    })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.showSnackbar('Maintenance record deleted successfully');
                            this.fetchMaintenanceLog();
                        } else {
                            this.showSnackbar(response.data.message || 'Failed to delete record', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting maintenance record:', error);
                        this.showSnackbar('Failed to delete record', 'error');
                    })
                    .finally(() => {
                        this.deleteDialog.show = false;
                        this.resetDeleteDialog();
                    });
                },
                openEditDialog(item) {
                    this.editDialog.item = item;
                    // Parse the ISO timestamp to get date and time components
                    try {
                        const date = new Date(item.timestamp);
                        // Format date as YYYY-MM-DD for the date input
                        this.editDialog.date = date.toISOString().split('T')[0];
                        // Format time as HH:MM for the time input
                        this.editDialog.time = date.toTimeString().slice(0, 5);
                    } catch (e) {
                        console.error('Error parsing timestamp:', e);
                        this.editDialog.date = '';
                        this.editDialog.time = '';
                    }
                    this.editDialog.show = true;
                },
                saveEditedRecord() {
                    if (!this.editDialog.item || !this.editDialog.date || !this.editDialog.time) {
                        this.showSnackbar('Please fill in both date and time', 'error');
                        return;
                    }
                    
                    // Combine date and time into an ISO timestamp
                    const newTimestamp = new Date(`${this.editDialog.date}T${this.editDialog.time}:00`).toISOString();
                    
                    axios.post('/maintenance/update', {
                        original_timestamp: this.editDialog.item.timestamp,
                        new_timestamp: newTimestamp
                    })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.showSnackbar('Maintenance record updated successfully');
                            this.fetchMaintenanceLog();
                        } else {
                            this.showSnackbar(response.data.message || 'Failed to update record', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error updating maintenance record:', error);
                        this.showSnackbar('Failed to update record', 'error');
                    })
                    .finally(() => {
                        this.editDialog.show = false;
                        this.editDialog.item = null;
                        this.editDialog.date = '';
                        this.editDialog.time = '';
                    });
                },
            }
        });
        </script>
    </body>
</html>
