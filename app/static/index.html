<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Odometer</title>
    <!-- Vuetify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.min.css" rel="stylesheet">
    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
    <!-- Custom styles -->
    <style>
        .stat-card {
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
        }
        .number-display {
            font-size: 32px;
            font-weight: bold;
        }
        .timer-display {
            font-size: 24px;
            font-weight: bold;
        }
        .maintenance-card {
            transition: all 0.3s;
        }
        .maintenance-table {
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app">
        <v-app :theme="isDarkMode ? 'dark' : 'light'">
            <v-main>
                <v-container fluid>
                    <!-- Move Pie Chart and Logo to top -->
                    <v-row>
                        <v-col cols="12" md="4" class="d-flex align-center justify-center">
                            <img src="/static/extension_logo.png" alt="Odometer Logo" style="width: 100%;">
                        </v-col>
                        <v-col cols="12" md="8">
                            <v-card elevation="4">
                                <v-card-title class="blue-grey white--text">
                                    <v-icon large color="white" class="mr-2">mdi-chart-pie</v-icon>
                                    Vehicle Usage Distribution
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div style="position: relative; height: 140px; width: 100%; margin: 0 auto; max-width: 350px; z-index: 1; padding: 0;">
                                        <canvas id="usageChart"></canvas>
                                    </div>
                                    <div class="caption mt-4 text-center">Proportion of time spent Armed vs Disarmed</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Stats Section -->
                    <v-row class="mt-6">
                        <v-col cols="12" md="4">
                            <v-card class="stat-card" elevation="4">
                                <v-card-title style="background-color: #135da3" class="white--text">
                                    <v-icon large color="white" class="mr-2">mdi-timer</v-icon>
                                    Total Uptime
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div class="timer-display">
                                        {{ formatTime(stats.total_minutes) }}
                                    </div>
                                    <div class="caption mt-2">Total vehicle uptime</div>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <v-col cols="12" md="4">
                            <v-card class="stat-card" elevation="4">
                                <v-card-title style="background-color: #2699d0" class="white--text">
                                    <v-icon large color="white" class="mr-2">mdi-shield-lock</v-icon>
                                    Armed Time
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div class="timer-display">
                                        {{ formatTime(stats.armed_minutes) }}
                                    </div>
                                    <div class="caption mt-2">Time vehicle has been armed</div>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <v-col cols="12" md="4">
                            <v-card class="stat-card" elevation="4">
                                <v-card-title style="background-color: #4fa483" class="white--text">
                                    <v-icon large color="white" class="mr-2">mdi-battery-sync</v-icon>
                                    Battery Swaps
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div class="number-display">
                                        {{ stats.battery_swaps }}
                                    </div>
                                    <div class="caption mt-2">Number of battery swaps detected</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <v-row class="mt-4">
                        <v-col cols="12" md="4">
                            <v-card class="stat-card" elevation="4">
                                <v-card-title style="background-color: #3699d0" class="white--text">
                                    <v-icon large color="white" class="mr-2">mdi-battery</v-icon>
                                    Battery Voltage
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div class="number-display">
                                        {{ stats.last_voltage.toFixed(2) }}V
                                    </div>
                                    <div class="caption mt-2">Current battery voltage</div>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <v-col cols="12" md="4">
                            <v-card class="stat-card" elevation="4">
                                <v-card-title style="background-color: #012f46" class="white--text">
                                    <v-icon large color="white" class="mr-2">mdi-thermometer</v-icon>
                                    CPU Temperature
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div class="number-display">
                                        {{ stats.cpu_temp.toFixed(1) }}°C
                                    </div>
                                    <div class="caption mt-2">Current CPU temperature</div>
                                </v-card-text>
                            </v-card>
                        </v-col>

                        <v-col cols="12" md="4">
                            <v-card class="stat-card" elevation="4">
                                <v-card-title style="background-color: #135da3" class="white--text">
                                    <v-icon large color="white" class="mr-2">mdi-battery-charging</v-icon>
                                    Energy Consumed
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div class="number-display">
                                        {{ stats.current_battery_wh.toFixed(2) }} Wh
                                    </div>
                                    <div class="caption mt-2">Current battery energy consumed</div>
                                    <div class="caption mt-1">
                                        <v-icon small>mdi-history</v-icon>
                                        Lifetime: {{ stats.total_wh_consumed.toFixed(2) }} Wh
                                    </div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Historical Chart for Voltage and Temperature -->
                    <v-row class="mt-6">
                        <v-col cols="12">
                            <v-card elevation="4">
                                <v-card-title class="teal darken-1 white--text">
                                    <v-icon large color="white" class="mr-2">mdi-chart-line</v-icon>
                                    Current Session Data
                                </v-card-title>
                                <v-card-text class="text-center pa-5">
                                    <div style="position: relative; height: 400px; width: 100%;">
                                        <canvas id="historyChart"></canvas>
                                        <v-progress-circular
                                            v-if="loading"
                                            indeterminate
                                            color="primary"
                                            size="32"
                                            width="3"
                                            style="position: absolute; top: 10px; right: 10px;"
                                        ></v-progress-circular>
                                    </div>
                                    <div class="caption mt-4 text-center">CPU Temperature and Battery Voltage for current session</div>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Missions Table -->
                    <v-row class="mt-6">
                        <v-col cols="12">
                            <v-card elevation="4">
                                <v-card-title class="teal darken-1 white--text">
                                    <v-icon large color="white" class="mr-2">mdi-history</v-icon>
                                    Mission History
                                </v-card-title>
                                <v-card-text>
                                    <v-data-table
                                        :headers="missionHeaders"
                                        :items="missions"
                                        :items-per-page="5"
                                        class="elevation-1"
                                        :footer-props="{
                                            'items-per-page-options': [5, 10, 15, -1],
                                            'items-per-page-text': 'Missions per page'
                                        }"
                                    >
                                        <template v-slot:item.start_time="{ item }">
                                            {{ formatDate(item.start_time) }}
                                        </template>
                                        <template v-slot:item.end_time="{ item }">
                                            {{ formatDate(item.end_time) }}
                                        </template>
                                        <template v-slot:item.duration="{ item }">
                                            {{ calculateDuration(item.start_time, item.end_time) }}
                                        </template>
                                        <template v-slot:item.start_voltage="{ item }">
                                            {{ item.start_voltage.toFixed(2) }}V
                                        </template>
                                        <template v-slot:item.end_voltage="{ item }">
                                            {{ item.end_voltage.toFixed(2) }}V
                                        </template>
                                        <template v-slot:item.start_cpu_temp="{ item }">
                                            {{ item.start_cpu_temp.toFixed(1) }}°C
                                        </template>
                                        <template v-slot:item.end_cpu_temp="{ item }">
                                            {{ item.end_cpu_temp.toFixed(1) }}°C
                                        </template>
                                        <template v-slot:item.total_ah="{ item }">
                                            {{ item.total_ah.toFixed(2) }}Ah
                                        </template>
                                    </v-data-table>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Data Export Section -->
                    <v-row class="mt-6">
                        <v-col cols="12">
                            <v-card elevation="4">
                                <v-card-title class="teal white--text">
                                    <v-icon large color="white" class="mr-2">mdi-file-download</v-icon>
                                    Export & Manage Data
                                </v-card-title>
                                <v-card-text class="text-center pt-6 pb-5 px-5">
                                    <v-row>
                                        <v-col cols="12" md="4">
                                            <v-btn block color="primary" @click="downloadOdometerData">
                                                <v-icon left>mdi-download</v-icon>
                                                Download Odometer Data
                                            </v-btn>
                                        </v-col>
                                        <v-col cols="12" md="4">
                                            <v-btn block color="secondary" @click="downloadMaintenanceData">
                                                <v-icon left>mdi-download</v-icon>
                                                Download Maintenance Log
                                            </v-btn>
                                        </v-col>
                                        <v-col cols="12" md="4">
                                            <v-btn block color="error" @click="showClearDialog">
                                                <v-icon left>mdi-delete</v-icon>
                                                Clear Temperature & Voltage History
                                            </v-btn>
                                        </v-col>
                                    </v-row>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Maintenance Section -->
                    <v-row class="mt-6">
                        <v-col cols="12">
                            <v-card class="maintenance-card" elevation="4">
                                <v-card-title class="indigo white--text">
                                    <v-icon large color="white" class="mr-2">mdi-tools</v-icon>
                                    Maintenance Log
                                </v-card-title>
                                <v-card-text>
                                    <v-row>
                                        <v-col cols="12">
                                            <v-data-table
                                                :headers="maintenanceHeaders"
                                                :items="maintenanceLog"
                                                :items-per-page="5"
                                                class="maintenance-table"
                                                :footer-props="{
                                                    'items-per-page-options': [5, 10, 15, -1],
                                                    'items-per-page-text': 'Records per page'
                                                }"
                                            >
                                                <template v-slot:item.timestamp="{ item }">
                                                    {{ formatDate(item.timestamp) }}
                                                </template>
                                                <template v-slot:item.event_type="{ item }">
                                                    <v-chip :color="getEventTypeColor(item.event_type)" dark>
                                                        {{ item.event_type }}
                                                    </v-chip>
                                                </template>
                                                <template v-slot:item.actions="{ item }">
                                                    <v-icon small class="mr-2" @click="openEditDialog(item)">
                                                        mdi-pencil
                                                    </v-icon>
                                                    <v-icon small color="error" @click="openDeleteDialog(item)">
                                                        mdi-delete
                                                    </v-icon>
                                                </template>
                                            </v-data-table>
                                        </v-col>
                                    </v-row>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Add Maintenance Record Section -->
                    <v-row class="mt-6 mb-10">
                        <v-col cols="12">
                            <v-card elevation="4">
                                <v-card-title class="blue darken-2 white--text">
                                    <v-icon large color="white" class="mr-2">mdi-plus-circle</v-icon>
                                    Add Maintenance Record
                                </v-card-title>
                                <v-card-text>
                                    <v-form ref="form" v-model="validForm" @submit.prevent="submitMaintenanceForm">
                                        <v-row>
                                            <v-col cols="12" md="4">
                                                <v-select
                                                    v-model="newRecord.event_type"
                                                    :items="eventTypes"
                                                    label="Event Type"
                                                    :rules="[v => !!v || 'Event type is required']"
                                                    required
                                                ></v-select>
                                            </v-col>
                                            <v-col cols="12" md="8">
                                                <v-textarea
                                                    v-model="newRecord.details"
                                                    label="Details"
                                                    :rules="[v => !!v || 'Details are required']"
                                                    required
                                                    rows="3"
                                                    counter
                                                ></v-textarea>
                                            </v-col>
                                        </v-row>
                                        <v-row>
                                            <v-col cols="12" class="text-center">
                                                <v-btn 
                                                    color="success" 
                                                    large 
                                                    :disabled="!validForm"
                                                    @click="submitMaintenanceForm"
                                                >
                                                    <v-icon left>mdi-content-save</v-icon>
                                                    Save Record
                                                </v-btn>
                                            </v-col>
                                        </v-row>
                                    </v-form>
                                </v-card-text>
                            </v-card>
                        </v-col>
                    </v-row>

                    <!-- Edit Maintenance Dialog -->
                    <v-dialog v-model="editDialog.show" max-width="500px">
                        <v-card>
                            <v-card-title class="blue darken-2 white--text">
                                <span>Edit Record Time</span>
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <v-form ref="editForm">
                                    <v-row>
                                        <v-col cols="12">
                                            <v-text-field
                                                v-model="editDialog.date"
                                                label="Date"
                                                type="date"
                                                required
                                            ></v-text-field>
                                        </v-col>
                                        <v-col cols="12">
                                            <v-text-field
                                                v-model="editDialog.time"
                                                label="Time"
                                                type="time"
                                                required
                                            ></v-text-field>
                                        </v-col>
                                    </v-row>
                                </v-form>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue darken-1" text @click="editDialog.show = false">Cancel</v-btn>
                                <v-btn color="blue darken-1" text @click="saveEditedRecord">Save</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Delete Maintenance Dialog -->
                    <v-dialog v-model="deleteDialog.show" max-width="500px">
                        <v-card>
                            <v-card-title class="error white--text">
                                <span>Delete Maintenance Record</span>
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <p class="text-body-1">
                                    <v-icon color="warning" class="mr-2">mdi-alert</v-icon>
                                    Are you sure you want to delete this maintenance record?
                                </p>
                                <v-list-item v-if="deleteDialog.item" two-line class="my-2 pa-2" outlined>
                                    <v-list-item-content>
                                        <v-list-item-title>
                                            <v-chip :color="getEventTypeColor(deleteDialog.item.event_type)" dark>
                                                {{ deleteDialog.item.event_type }}
                                            </v-chip>
                                        </v-list-item-title>
                                        <v-list-item-subtitle class="mt-1">
                                            <strong>{{ formatDate(deleteDialog.item.timestamp) }}</strong>
                                        </v-list-item-subtitle>
                                        <v-list-item-subtitle class="mt-1 text-wrap">
                                            {{ deleteDialog.item.details }}
                                        </v-list-item-subtitle>
                                    </v-list-item-content>
                                </v-list-item>
                                <v-checkbox
                                    v-if="deleteDialog.step === 1"
                                    v-model="deleteDialog.confirmed"
                                    label="I understand this action cannot be undone"
                                    class="mt-4"
                                ></v-checkbox>
                                <v-alert
                                    v-if="deleteDialog.step === 2"
                                    type="warning"
                                    class="mt-4"
                                >
                                    This is your final confirmation. This record will be permanently deleted.
                                </v-alert>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue-grey darken-1" text @click="cancelDeleteDialog">Cancel</v-btn>
                                <v-btn 
                                    v-if="deleteDialog.step === 1"
                                    color="error" 
                                    text 
                                    :disabled="!deleteDialog.confirmed" 
                                    @click="deleteDialog.step = 2"
                                >Continue</v-btn>
                                <v-btn 
                                    v-if="deleteDialog.step === 2"
                                    color="error" 
                                    text 
                                    @click="deleteMaintenanceRecord"
                                >Confirm Delete</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Clear Data Confirmation Dialog -->
                    <v-dialog v-model="clearDialog.show" max-width="500px">
                        <v-card>
                            <v-card-title class="error white--text">
                                <span>Clear Temperature & Voltage History</span>
                            </v-card-title>
                            <v-card-text class="pt-4">
                                <p class="text-body-1">
                                    <v-icon color="warning" class="mr-2">mdi-alert</v-icon>
                                    This will remove all historical temperature and voltage data, but will preserve uptime statistics.
                                </p>
                                <p class="text-body-1 mt-2">
                                    Are you sure you want to continue?
                                </p>
                                <v-checkbox
                                    v-if="clearDialog.step === 1"
                                    v-model="clearDialog.confirmed"
                                    label="I understand this action cannot be undone"
                                    class="mt-4"
                                ></v-checkbox>
                                <v-alert
                                    v-if="clearDialog.step === 2"
                                    type="warning"
                                    class="mt-4"
                                >
                                    This is your final confirmation. All temperature and voltage history will be permanently deleted.
                                </v-alert>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="blue-grey darken-1" text @click="cancelClearDialog">Cancel</v-btn>
                                <v-btn 
                                    v-if="clearDialog.step === 1"
                                    color="error" 
                                    text 
                                    :disabled="!clearDialog.confirmed" 
                                    @click="clearDialog.step = 2"
                                >Continue</v-btn>
                                <v-btn 
                                    v-if="clearDialog.step === 2"
                                    color="error" 
                                    text 
                                    @click="clearTempVoltageHistory"
                                >Confirm Delete</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <!-- Snackbar for notifications -->
                    <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="3000">
                        {{ snackbar.text }}
                        <template v-slot:action="{ attrs }">
                            <v-btn icon v-bind="attrs" @click="snackbar.show = false">
                                <v-icon>mdi-close</v-icon>
                            </v-btn>
                        </template>
                    </v-snackbar>
                </v-container>
            </v-main>
        </v-app>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.14/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            vuetify: new Vuetify({
                theme: {
                    dark: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
                }
            }),
            data() {
                return {
                    isDarkMode: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches,
                    stats: {
                        total_minutes: 0,
                        armed_minutes: 0,
                        disarmed_minutes: 0,
                        battery_swaps: 0,
                        last_voltage: 0.0,
                        cpu_temp: 0.0,
                        total_wh_consumed: 0.0,
                        current_battery_wh: 0.0,
                    },
                    maintenanceLog: [],
                    maintenanceHeaders: [
                        { text: 'Date/Time', value: 'timestamp' },
                        { text: 'Event Type', value: 'event_type' },
                        { text: 'Details', value: 'details' },
                        { text: 'Actions', value: 'actions', sortable: false, align: 'end' }
                    ],
                    newRecord: {
                        event_type: '',
                        details: ''
                    },
                    eventTypes: ['Repair', 'Replacement', 'Maintenance', 'Inspection', 'Note'],
                    validForm: false,
                    snackbar: {
                        show: false,
                        text: '',
                        color: 'success'
                    },
                    updateInterval: null,
                    themeCheckInterval: null,
                    themeObserver: null,
                    usageChart: null,
                    historyChart: null,
                    historicalData: [],
                    timeRange: '15m',
                    loading: false,
                    editDialog: {
                        show: false,
                        item: null,
                        date: '',
                        time: ''
                    },
                    updateCount: 0,
                    themeMediaQuery: null,
                    clearDialog: {
                        show: false,
                        step: 1,
                        confirmed: false
                    },
                    deleteDialog: {
                        show: false,
                        step: 1,
                        confirmed: false,
                        item: null
                    },
                    chartOptions: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',
                                    displayFormats: {
                                        minute: 'MMM d HH:mm',
                                        hour: 'MMM d HH:mm',
                                        day: 'MMM d',
                                        week: 'MMM d',
                                        month: 'MMM yyyy'
                                    }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                grid: {
                                    color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            'y-voltage': {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Voltage (V)',
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                ticks: {
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                grid: {
                                    color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            'y-temp': {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)',
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                ticks: {
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                },
                                grid: {
                                    color: this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: this.isDarkMode ? '#ffffff' : '#666666'
                                }
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: function(tooltipItems) {
                                        return format(new Date(tooltipItems[0].parsed.x), 'MMM d, yyyy HH:mm:ss');
                                    },
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2);
                                            if (context.dataset.yAxisID === 'y-voltage') {
                                                label += ' V';
                                            } else if (context.dataset.yAxisID === 'y-temp') {
                                                label += ' °C';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    },
                    missionHeaders: [
                        { text: 'Start Time', value: 'start_time' },
                        { text: 'End Time', value: 'end_time' },
                        { text: 'Duration', value: 'duration' },
                        { text: 'Start Voltage', value: 'start_voltage' },
                        { text: 'End Voltage', value: 'end_voltage' },
                        { text: 'Start CPU Temp', value: 'start_cpu_temp' },
                        { text: 'End CPU Temp', value: 'end_cpu_temp' },
                        { text: 'Total Ah', value: 'total_ah' }
                    ],
                    missions: [],
                    currentMission: null,
                }
            },
            mounted() {
                this.fetchStats();
                this.fetchMaintenanceLog();
                this.fetchHistoricalData();
                this.fetchMissions();
                
                // Set up initial theme detection
                this.setupThemeDetection();
                
                // Update stats every 30 seconds, but only if tab is visible
                this.updateInterval = setInterval(() => {
                    if (!document.hidden) {
                        this.fetchStats();
                        this.fetchMissions();
                        // Fetch historical data every 2 cycles (1 minute) instead of every 4 cycles (2 minutes)
                        if (this.updateCount % 2 === 0) {
                            this.fetchHistoricalData();
                        }
                        // Check for theme changes in BlueOS every cycle
                        this.checkBlueOSTheme();
                        this.updateCount++;
                    }
                }, 30000);
                
                // Set a shorter interval just for theme checking (every 2 seconds)
                this.themeCheckInterval = setInterval(() => {
                    if (!document.hidden) {
                        this.checkBlueOSTheme();
                    }
                }, 2000);
            },
            beforeDestroy() {
                clearInterval(this.updateInterval);
                clearInterval(this.themeCheckInterval);
                
                // Remove mutation observer if it exists
                if (this.themeObserver) {
                    this.themeObserver.disconnect();
                }
                
                // Remove theme change listeners
                if (this.themeMediaQuery) {
                    this.themeMediaQuery.removeEventListener('change', this.handleThemeChange);
                }
                // Cleanup charts
                if (this.usageChart) {
                    this.usageChart.destroy();
                }
                if (this.historyChart) {
                    this.historyChart.destroy();
                }
            },
            watch: {
                timeRange() {
                    // Always get fresh data when changing time ranges
                    this.fetchHistoricalData();
                },
                isDarkMode() {
                    // Update Vuetify theme when dark mode changes
                    this.$vuetify.theme.dark = this.isDarkMode;
                    // Update chart themes
                    this.updateChartsTheme();
                }
            },
            methods: {
                setupThemeDetection() {
                    // First try to detect BlueOS theme through parent window
                    const detected = this.checkBlueOSTheme();
                    
                    // Try to set up a mutation observer for the parent document
                    try {
                        if (window.parent && window.parent.document && window.parent.document.body) {
                            // Create a mutation observer to watch for class changes on the parent body
                            this.themeObserver = new MutationObserver((mutations) => {
                                for (const mutation of mutations) {
                                    if (mutation.type === 'attributes' && 
                                        (mutation.attributeName === 'class' || 
                                         mutation.attributeName === 'data-theme')) {
                                        this.checkBlueOSTheme();
                                        break;
                                    }
                                }
                            });
                            
                            // Start observing the parent body for class and attribute changes
                            this.themeObserver.observe(window.parent.document.body, {
                                attributes: true,
                                attributeFilter: ['class', 'data-theme']
                            });
                            
                            console.log('Set up BlueOS theme mutation observer');
                        }
                    } catch (e) {
                        console.log('Unable to set up mutation observer for parent frame:', e);
                    }
                    
                    // As fallback, setup media query listener for system theme changes
                    this.themeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    this.themeMediaQuery.addEventListener('change', this.handleThemeChange);
                },
                checkBlueOSTheme() {
                    try {
                        if (window.parent && window.parent.document) {
                            // Get BlueOS theme state - could be in different elements depending on version
                            const parentBody = window.parent.document.body;
                            const isDarkTheme = 
                                parentBody.classList.contains('theme--dark') || 
                                parentBody.getAttribute('data-theme') === 'dark' ||
                                parentBody.querySelector('.theme--dark') !== null;
                            
                            // Also check for specific CSS variables that might indicate theme
                            const computedStyle = window.getComputedStyle(parentBody);
                            const bgColor = computedStyle.getPropertyValue('--v-background-base') || 
                                           computedStyle.backgroundColor;
                            
                            // If we have a background color, check if it's dark
                            if (bgColor && bgColor !== '') {
                                // If it's a dark background and we're not in dark mode, or vice versa
                                const isDarkBg = this.isColorDark(bgColor);
                                if (isDarkBg !== null && isDarkBg !== this.isDarkMode) {
                                    console.log(`BlueOS theme detected as ${isDarkBg ? 'dark' : 'light'} based on background color`);
                                    this.isDarkMode = isDarkBg;
                                    return true;
                                }
                            }
                            
                            // Only update if different from current state
                            if (this.isDarkMode !== isDarkTheme) {
                                console.log(`BlueOS theme changed to ${isDarkTheme ? 'dark' : 'light'}`);
                                this.isDarkMode = isDarkTheme;
                            }
                            
                            // Successful BlueOS theme detection
                            return true;
                        }
                    } catch (e) {
                        console.log('Unable to access parent frame for theme detection');
                    }
                    return false;
                },
                isColorDark(color) {
                    try {
                        // Parse the color to get RGB values
                        let r, g, b;
                        
                        // Handle hex color
                        if (color.startsWith('#')) {
                            if (color.length === 4) { // #RGB format
                                r = parseInt(color[1] + color[1], 16);
                                g = parseInt(color[2] + color[2], 16);
                                b = parseInt(color[3] + color[3], 16);
                            } else { // #RRGGBB format
                                r = parseInt(color.slice(1, 3), 16);
                                g = parseInt(color.slice(3, 5), 16);
                                b = parseInt(color.slice(5, 7), 16);
                            }
                        } 
                        // Handle rgb/rgba color
                        else if (color.startsWith('rgb')) {
                            const parts = color.match(/(\d+)/g);
                            if (parts && parts.length >= 3) {
                                r = parseInt(parts[0]);
                                g = parseInt(parts[1]);
                                b = parseInt(parts[2]);
                            }
                        }
                        else {
                            return null; // Unsupported color format
                        }
                        
                        // Calculate relative luminance using sRGB
                        // Formula: 0.2126*R + 0.7152*G + 0.0722*B
                        const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
                        
                        // If luminance is less than 0.5, it's considered dark
                        return luminance < 0.5;
                    } catch (e) {
                        console.log('Error parsing color:', e);
                        return null;
                    }
                },
                handleThemeChange(e) {
                    // Only apply system preference if we couldn't detect BlueOS theme
                    if (!this.checkBlueOSTheme()) {
                        this.isDarkMode = e.matches;
                    }
                },
                updateChartsTheme() {
                    // Update chart colors based on theme
                    if (this.historyChart) {
                        // Update grid and text colors
                        const textColor = this.isDarkMode ? '#ffffff' : '#666666';
                        const gridColor = this.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                        
                        this.historyChart.options.scales.x.grid.color = gridColor;
                        this.historyChart.options.scales.x.ticks.color = textColor;
                        this.historyChart.options.scales['y-voltage'].grid.color = gridColor;
                        this.historyChart.options.scales['y-voltage'].ticks.color = textColor;
                        this.historyChart.options.scales['y-temp'].grid.color = gridColor;
                        this.historyChart.options.scales['y-temp'].ticks.color = textColor;
                        
                        this.historyChart.update();
                    }
                    
                    if (this.usageChart) {
                        // Update legend colors
                        this.usageChart.options.plugins.legend.labels.color = this.isDarkMode ? '#ffffff' : '#666666';
                        this.usageChart.update();
                    }
                },
                fetchStats() {
                    axios.get('/stats')
                        .then(response => {
                            if (response.data.status === 'success') {
                                // Save old values to check for changes
                                const oldTemp = this.stats.cpu_temp;
                                const oldVoltage = this.stats.last_voltage;
                                
                                // Update stats
                                this.stats = response.data.data;
                                this.updateUsageChart();
                                
                                // If we're in the 15-minute view and values changed, immediately 
                                // add the new point to the chart for real-time updates
                                if (this.timeRange === '15m' && this.historyChart && 
                                    (oldTemp !== this.stats.cpu_temp || oldVoltage !== this.stats.last_voltage)) {
                                    
                                    const now = new Date();
                                    
                                    // Add new voltage point
                                    if (this.historyChart.data.datasets[0].data) {
                                        this.historyChart.data.labels.push(now);
                                        this.historyChart.data.datasets[0].data.push(this.stats.last_voltage);
                                    }
                                    
                                    // Add new temperature point if it's valid (greater than 0)
                                    if (this.historyChart.data.datasets[1].data && this.stats.cpu_temp > 0) {
                                        this.historyChart.data.datasets[1].data.push({
                                            x: now,
                                            y: this.stats.cpu_temp
                                        });
                                    }
                                    
                                    // Update the chart
                                    this.historyChart.update();
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching stats:', error);
                            this.showSnackbar('Failed to fetch vehicle stats', 'error');
                        });
                },
                fetchMaintenanceLog() {
                    axios.get('/maintenance')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.maintenanceLog = response.data.data;
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching maintenance log:', error);
                            this.showSnackbar('Failed to fetch maintenance log', 'error');
                        });
                },
                submitMaintenanceForm() {
                    if (!this.$refs.form.validate()) return;

                    axios.post('/maintenance', this.newRecord)
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.showSnackbar('Maintenance record added successfully');
                                this.newRecord.event_type = '';
                                this.newRecord.details = '';
                                this.$refs.form.reset();
                                // Refresh the maintenance log
                                this.fetchMaintenanceLog();
                            } else {
                                this.showSnackbar(response.data.message || 'Failed to add record', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error adding maintenance record:', error);
                            this.showSnackbar('Failed to add maintenance record', 'error');
                        });
                },
                downloadOdometerData() {
                    window.location.href = '/download/odometer';
                },
                downloadMaintenanceData() {
                    window.location.href = '/download/maintenance';
                },
                downloadCSV(csvData, filename) {
                    const blob = new Blob([csvData], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', filename);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },
                formatTime(minutes) {
                    const days = Math.floor(minutes / (60 * 24));
                    const hours = Math.floor((minutes % (60 * 24)) / 60);
                    const mins = minutes % 60;
                    
                    let result = '';
                    if (days > 0) result += `${days}d `;
                    if (hours > 0 || days > 0) result += `${hours}h `;
                    result += `${mins}m`;
                    
                    return result;
                },
                formatDate(isoString) {
                    try {
                        const date = new Date(isoString);
                        // Use Intl.DateTimeFormat for better localization with time zone
                        return new Intl.DateTimeFormat(undefined, {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            timeZoneName: 'short'
                        }).format(date);
                    } catch (e) {
                        console.error('Error formatting date:', e);
                        return isoString;
                    }
                },
                getEventTypeColor(type) {
                    const colors = {
                        'Repair': 'red',
                        'Replacement': 'blue',
                        'Maintenance': 'green',
                        'Inspection': 'amber',
                        'Note': 'grey'
                    };
                    return colors[type] || 'primary';
                },
                showSnackbar(text, color = 'success') {
                    this.snackbar.text = text;
                    this.snackbar.color = color;
                    this.snackbar.show = true;
                },
                updateUsageChart() {
                    const ctx = document.getElementById('usageChart');
                    const armedMinutes = this.stats.armed_minutes || 0;
                    const disarmedMinutes = this.stats.disarmed_minutes || 0;
                    
                    // Destroy previous chart if it exists
                    if (this.usageChart) {
                        this.usageChart.destroy();
                        this.usageChart = null;
                    }
                    
                    // If no data or zero total, show placeholder
                    if (armedMinutes === 0 && disarmedMinutes === 0) {
                        const placeholderData = {
                            labels: ['No Data Available'],
                            datasets: [{
                                data: [1],
                                backgroundColor: [this.isDarkMode ? '#424242' : '#e0e0e0'],
                                borderWidth: 0
                            }]
                        };
                        
                        this.usageChart = new Chart(ctx, {
                            type: 'doughnut',
                            data: placeholderData,
                            options: this.getChartOptions(true)
                        });
                        return;
                    }
                    
                    // Prepare real data
                    const data = {
                        labels: ['Armed Time', 'Disarmed Time'],
                        datasets: [{
                            data: [armedMinutes, disarmedMinutes],
                            backgroundColor: ['#4CAF50', '#FFC107'],
                            borderWidth: 2,
                            borderColor: this.isDarkMode ? '#424242' : '#fff'
                        }]
                    };
                    
                    this.usageChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: data,
                        options: this.getChartOptions()
                    });
                },
                getChartOptions(isPlaceholder = false) {
                    return {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 500 },
                        cutout: '60%',
                        layout: {
                            padding: {
                                top: 0,
                                bottom: 0,
                                left: 0,
                                right: 0
                            }
                        },
                        plugins: {
                            legend: {
                                display: !isPlaceholder,
                                position: 'right',
                                labels: {
                                    padding: 5,
                                    color: this.isDarkMode ? '#ffffff' : '#666666',
                                    font: {
                                        size: 11
                                    },
                                    boxWidth: 10
                                }
                            },
                            tooltip: {
                                enabled: !isPlaceholder,
                                callbacks: {
                                    label: (context) => {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        const formattedTime = this.formatTime(value);
                                        return `${label}: ${formattedTime} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    };
                },
                fetchHistoricalData() {
                    // If already loading, don't start another request
                    if (this.loading) return;
                    
                    this.loading = true;
                    
                    // Add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    const xhr = new XMLHttpRequest();
                    xhr.open('GET', `/download/odometer?t=${timestamp}`, true);
                    xhr.responseType = 'text';
                    
                    // Keep track of when this request started to avoid race conditions
                    const requestTimestamp = Date.now();
                    
                    xhr.onload = () => {
                        if (xhr.status === 200) {
                            try {
                                const csvData = xhr.responseText;
                                const lines = csvData.split('\n');
                                const headers = lines[0].split(',');
                                
                                // Find indices for timestamp, voltage and cpu_temp
                                const timestampIndex = headers.indexOf('timestamp');
                                const voltageIndex = headers.indexOf('voltage');
                                const cpuTempIndex = headers.indexOf('cpu_temp');
                                
                                if (timestampIndex === -1 || voltageIndex === -1) {
                                    throw new Error('Required columns not found in CSV data');
                                }
                                
                                // Parse data rows
                                const data = [];
                                for (let i = 1; i < lines.length; i++) {
                                    if (!lines[i].trim()) continue;
                                    
                                    const values = lines[i].split(',');
                                    if (values.length > Math.max(timestampIndex, voltageIndex, cpuTempIndex)) {
                                        const timestamp = new Date(values[timestampIndex]);
                                        let voltage = parseFloat(values[voltageIndex]);
                                        
                                        // Completely skip temperature readings that are missing, zero, or invalid
                                        let cpuTemp = null;
                                        if (cpuTempIndex !== -1 && values[cpuTempIndex] && values[cpuTempIndex].trim() !== '') {
                                            const tempValue = parseFloat(values[cpuTempIndex]);
                                            if (!isNaN(tempValue) && tempValue > 0) {
                                                cpuTemp = tempValue;
                                            }
                                        }
                                        
                                        if (!isNaN(voltage) && !isNaN(timestamp.getTime())) {
                                            data.push({
                                                timestamp,
                                                voltage,
                                                cpuTemp
                                            });
                                        }
                                    }
                                }
                                
                                console.log('Total data points loaded:', data.length);
                                this.historicalData = data;
                                this.updateHistoryChart();
                            } catch (e) {
                                console.error('Error parsing CSV data:', e);
                                this.showSnackbar('Error parsing CSV data: ' + e.message, 'error');
                            }
                        } else {
                            console.error('Failed to load CSV data:', xhr.status, xhr.statusText);
                            this.showSnackbar('Failed to load historical data', 'error');
                        }
                        // Clear loading after a slight delay to prevent flicker
                        setTimeout(() => {
                            this.loading = false;
                        }, 300);
                    };
                    
                    xhr.onerror = () => {
                        console.error('Network error while fetching CSV data');
                        this.showSnackbar('Network error while fetching data', 'error');
                        this.loading = false;
                    };
                    
                    xhr.send();
                },
                
                updateHistoryChart() {
                    if (!this.historyChart) {
                        const ctx = document.getElementById('historyChart');
                        this.historyChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                datasets: [
                                    {
                                        label: 'Battery Voltage',
                                        yAxisID: 'y-voltage',
                                        data: [],
                                        borderColor: '#2196F3',
                                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    },
                                    {
                                        label: 'CPU Temperature',
                                        yAxisID: 'y-temp',
                                        data: [],
                                        borderColor: '#F44336',
                                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                                        fill: true,
                                        tension: 0.4
                                    }
                                ]
                            },
                            options: this.chartOptions
                        });
                    }

                    try {
                        // Filter data for current mission
                        const filteredData = this.historicalData
                            .filter(d => {
                                if (!this.currentMission) return false;
                                const timestamp = new Date(d.timestamp);
                                return timestamp >= new Date(this.currentMission.start_time);
                            })
                            .sort((a, b) => a.timestamp - b.timestamp);

                        // Update voltage data
                        this.historyChart.data.datasets[0].data = filteredData.map(d => ({
                            x: d.timestamp,
                            y: d.voltage
                        }));

                        // Update temperature data (filter out invalid values)
                        this.historyChart.data.datasets[1].data = filteredData
                            .filter(d => d.cpuTemp !== null && d.cpuTemp > 0)
                            .map(d => ({
                                x: d.timestamp,
                                y: d.cpuTemp
                            }));

                        // Update the chart
                        this.historyChart.update();

                    } catch (e) {
                        console.error("Error updating chart:", e);
                    }
                },
                
                calculateDuration(startTime, endTime) {
                    const start = new Date(startTime);
                    const end = new Date(endTime);
                    const diff = end - start;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    return `${hours}h ${minutes}m`;
                },
                fetchMissions() {
                    axios.get('/missions')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.currentMission = response.data.data.current_mission;
                                this.missions = response.data.data.completed_missions;
                                // Update chart with current mission data
                                this.updateHistoryChart();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching missions:', error);
                            this.showSnackbar('Failed to fetch mission history', 'error');
                        });
                },
                showClearDialog() {
                    this.clearDialog.show = true;
                },
                cancelClearDialog() {
                    this.clearDialog.show = false;
                    this.resetClearDialog();
                },
                clearTempVoltageHistory() {
                    axios.post('/clear_history')
                        .then(response => {
                            if (response.data.status === 'success') {
                                this.showSnackbar('Temperature and voltage history cleared successfully');
                                this.fetchHistoricalData();
                            } else {
                                this.showSnackbar(response.data.message || 'Failed to clear temperature and voltage history', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error clearing temperature and voltage history:', error);
                            this.showSnackbar('Failed to clear temperature and voltage history', 'error');
                        })
                        .finally(() => {
                            this.clearDialog.show = false;
                            this.resetClearDialog();
                        });
                },
                resetClearDialog() {
                    // Reset dialog state after closing
                    setTimeout(() => {
                        this.clearDialog.step = 1;
                        this.clearDialog.confirmed = false;
                    }, 300);
                },
                openDeleteDialog(item) {
                    this.deleteDialog.item = item;
                    this.deleteDialog.show = true;
                },
                cancelDeleteDialog() {
                    this.deleteDialog.show = false;
                    this.resetDeleteDialog();
                },
                resetDeleteDialog() {
                    // Reset dialog state after closing
                    setTimeout(() => {
                        this.deleteDialog.step = 1;
                        this.deleteDialog.confirmed = false;
                        this.deleteDialog.item = null;
                    }, 300);
                },
                deleteMaintenanceRecord() {
                    if (!this.deleteDialog.item) return;
                    
                    axios.post('/maintenance/delete', {
                        timestamp: this.deleteDialog.item.timestamp
                    })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.showSnackbar('Maintenance record deleted successfully');
                            this.fetchMaintenanceLog();
                        } else {
                            this.showSnackbar(response.data.message || 'Failed to delete record', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting maintenance record:', error);
                        this.showSnackbar('Failed to delete record', 'error');
                    })
                    .finally(() => {
                        this.deleteDialog.show = false;
                        this.resetDeleteDialog();
                    });
                },
            }
        });
        </script>
    </body>
</html>
